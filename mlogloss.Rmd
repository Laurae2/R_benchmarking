---
title: "Benchmarks: Multi-class Logloss"
output:
  html_notebook:
    collapsed: no
    theme: united
    toc: yes
    toc_depth: 6
    toc_float: yes

---

This notebook is all about benchmarking some R code used in this package.

Hardware / Software used:

* Intel i7-4600U
* Compilation flags for C/C++: `-O2 -Wall $(DEBUGFLAG) -mtune=core2` (R's defaults)
* Windows Server 2012 R2
* R 3.3.2 + Intel MKL

# Libraries

```{r init}
library(data.table)
library(microbenchmark)
library(Rcpp)
library(ggplot2)
library(plotly)
```

```{r based}

# Helper function to print data well in tables
print_well <- function(data, digits = 6) {
  
  # To milliseconds
  data <- data / 1000000
  
  # Sprintf helper
  sprintf_helper <- paste0("%.0", digits, "f")
  
  cat("| Min | 25% | 50% | 75% | Max | Mean |  \n| --: | --: | --: | --: | --: | --: |  \n| ", sprintf(sprintf_helper, min(data)), " | ", sprintf(sprintf_helper, quantile(data, probs = 0.25)), " | ", sprintf(sprintf_helper, median(data)), " | ", sprintf(sprintf_helper, quantile(data, probs = 0.75)), " | ", sprintf(sprintf_helper, max(data)), " | ", sprintf(sprintf_helper, mean(data)), " |  \n", sep = "")
  
  return(data)
  
}

# Test case function
# Arguments renamed to avoid recursive clash
test_case <- function(f, preds, labels, eps) {
  cat("Test case: ", paste(do.call(f, list(preds = preds[1:50],
                                           labels = labels[1:5],
                                           eps = 1e-15)), collapse = ", "), "  \n")
}

# Fastest Logloss function
cppFunction("double Lpp_logloss1(NumericVector preds, NumericVector labels, double eps) {
  NumericVector clamped = clamp(eps, preds, 1 - eps);
  NumericVector loggy = -log(1 - clamped);
  double logloss = sum(loggy) / loggy.size();
  return logloss;
}")

# Fastest Transformer function
cppFunction("NumericVector Lpp_vec2mat2vec(NumericVector preds, NumericVector labels) {
  int labels_size = labels.size();
  NumericVector selected(labels_size);
  selected = (preds.size() / labels_size) * seq(0, labels_size - 1);
  selected = selected + labels;
  NumericVector to_return(labels_size);
  to_return = preds[selected];
  return to_return;
}")

```

# Benchmarking Clamped Vector to Logloss

For a 10-class vector of 1,000,000 observations:

* Vector A of length=(1000000 * 10)
* Vector B of length=(1000000) with 10 classes

```
A = [1:1, 1:2, 1:3, 1:4... 1:10, 2:1, 2:2, 2:3..., 1000000:8, 1000000:9, 1000000:10]
B = [3, 5, 9, 1, 4, 8, 6, ...]
```

Get the following Vector C, D, and E:

```
C = [1:4, 2:6, 3:10, 4:2, 5:5, 6:9, 7:7, ...]
D = Clamped C by 1e-15
E = Mean of logloss(D, B)
```

# Initialize data

```{r bench1}
# Generate random data
set.seed(11111)
data <- runif(10000000, 0, 1)
labels <- round(runif(1000000, 0, 9), digits = 0)

# Background truth example (no clamping though)
array(data[1:50], dim = c(10, 5))
labels[1:5]
data[c(1 + labels[1], 11 + labels[2], 21 + labels[3], 31 + labels[4], 41 + labels[5])]
-log(1 - data[c(1 + labels[1], 11 + labels[2], 21 + labels[3], 31 + labels[4], 41 + labels[5])])
mean(-log(1 - data[c(1 + labels[1], 11 + labels[2], 21 + labels[3], 31 + labels[4], 41 + labels[5])]))

# How many digits for benchmarking in milliseconds
my_digits <- 6L

# How many runs for benchmarking?
my_runs <- 1000L
```

# Benchmarks

```{r bench2, results="asis"}

# ===== BLOCK 1 =====
faster1 <- function(preds, labels, eps = 1e-15) {
  temp_preds <- Lpp_vec2mat2vec(preds, labels)
  temp_log <- Lpp_logloss1(temp_preds, labels, eps)
  return(temp_log)
}
test_case(faster1, preds = data, labels = labels, eps = 1e-15)
data1 <- print_well(microbenchmark(faster1(data, labels), times = my_runs)$time, digits = my_digits)

# ===== BLOCK 2 =====
faster2 <- function(preds, labels, eps = 1e-15) {
  x <- pmin(pmax(preds[((0:(length(labels) - 1)) * (length(preds) / length(labels))) + labels + 1], eps), 1 - eps)
  return(-mean(log(1 - x)))
}
test_case(faster2, preds = data, labels = labels, eps = 1e-15)
data2 <- print_well(microbenchmark(faster2(data, labels), times = my_runs)$time, digits = my_digits)

# ===== BLOCK 3 =====
faster3 <- function(preds, labels, eps = 1e-15) {
  x <- pmin(pmax(preds[((0:(length(labels) - 1)) * (length(preds) / length(labels))) + labels + 1], eps), 1 - eps)
  return(-sum(log(1 - x)) / length(labels))
}
test_case(faster3, preds = data, labels = labels, eps = 1e-15)
data3 <- print_well(microbenchmark(faster3(data, labels), times = my_runs)$time, digits = my_digits)

# ===== BLOCK 4 =====
cppFunction("double faster4(NumericVector preds, NumericVector labels, double eps) {
  int labels_size = labels.size();
  NumericVector selected(labels_size);
  selected = (preds.size() / labels_size) * seq(0, labels_size - 1);
  selected = selected + labels;
  NumericVector to_return(labels_size);
  to_return = preds[selected];
  NumericVector clamped = clamp(eps, to_return, 1 - eps);
  NumericVector loggy = -(log(1 - clamped));
  double logloss = sum(loggy) / labels_size;
  return logloss;
}")
test_case(faster4, preds = data, labels = labels, eps = 1e-15)
data4 <- print_well(microbenchmark(faster4(data, labels, eps = 1e-15), times = my_runs)$time, digits = my_digits)

```

# Summary Results

```{r bench3}

data_time <- data.table(rbindlist(list(data.frame(Time = data1, Bench = "faster1"),
                                       data.frame(Time = data2, Bench = "faster2"),
                                       data.frame(Time = data3, Bench = "faster3"),
                                       data.frame(Time = data4, Bench = "faster4"))))
data_time <- data_time[, t_mean := mean(Time), by = Bench]
data_time <- data_time[, t_median := median(Time), by = Bench]
data_time$Benchs <- data_time$Bench 
levels(data_time$Benchs) <- paste0("faster", 1:4, "= [", sprintf(paste0("%.0", my_digits, "f"), data_time[, list(min(Time)), by = Bench]$V1), ", ", sprintf(paste0("%.0", my_digits, "f"), data_time[, list(max(Time)), by = Bench]$V1), "], mean=", sprintf(paste0("%.0", my_digits, "f"), data_time[, list(mean(Time)), by = Bench]$V1), ", median=", sprintf(paste0("%.0", my_digits, "f"), data_time[, list(median(Time)), by = Bench]$V1))

my_time <- data_time[, list(min(Time), quantile(Time, probs = 0.25), median(Time), quantile(Time, probs = 0.75), max(Time), mean(Time)), by = Bench]
colnames(my_time) <- c("Function", "Min", "25%", "50%", "75%", "Max", "Mean")
my_time <- my_time[order(Mean, decreasing = FALSE), ]
print(my_time, digits = 6)

```

# Plot Results

```{r bench4, fig.height=6, fig.width=10}

ggplotly(ggplot(data = data_time, aes(x = Time)) + geom_histogram(aes(y = ..density..), bins = 20, color = "darkblue", fill = "lightblue") + facet_wrap(~ Benchs, ncol = 2) + geom_vline(aes(xintercept = t_mean), color = "blue", linetype = "dashed", size = 2) + geom_vline(aes(xintercept = t_median), color = "red", linetype = "dashed", size = 2) + labs(x = "Time (Milliseconds)", y = "Density") + theme_bw())

```

```{r bench5, fig.height=6, fig.width=10}
ggplotly(ggplot(data = data_time[, .(Time, Bench)], aes(x = Time, y = ..count.., fill = Bench)) + geom_histogram(aes(y = ..density..), bins = 100, position = "fill") + labs(x = "Time (Milliseconds)", y = "Density") + theme_bw())
```

```{r bench6, fig.height=6, fig.width=10}
ggplotly(ggplot(data = data_time[, .(Time, Bench)], aes(x = Time, y = ..count.., fill = Bench)) + geom_density(position = "fill") + labs(x = "Time (Milliseconds)", y = "Density") + theme_bw())
```

